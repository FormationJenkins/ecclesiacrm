<?php

require '../Include/Config.php';

// This file is generated by Composer
require_once dirname(__FILE__).'/../vendor/autoload.php';
use EcclesiaCRM\Slim\Middleware\VersionMiddleware;
use Slim\Middleware\JwtAuthentication;
use Slim\Container;
use Slim\App;
use Slim\HttpCache\Cache;
use Slim\HttpCache\CacheProvider;
use EcclesiaCRM\TokenQuery;

// Instantiate the app
$settings = require __DIR__.'/../Include/slim/settings.php';

$container = new Container;
$container['cache'] = function () {
    return new CacheProvider();
};

// Add middleware to the application
$app = new App($container);

$app->add(new VersionMiddleware());

$app->add(new Cache('public', 60));

$app->add(new JwtAuthentication([
    "secret" => TokenQuery::Create()->findOneByType("secret")->getToken(),
    "path" => "/api",
    "algorithm" => ["HS256"],
    "error" => function ($response, $arguments) {
        $data["status"] = "error";
        $data["message"] = $arguments["message"];
        return $response
            ->withHeader("Content-Type", "application/json")
            ->write(json_encode($data, JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT));
    }
]));

// Set up
require __DIR__.'/dependencies.php';
require __DIR__.'/../Include/slim/error-handler.php';

// calendar and events routes
require __DIR__.'/routes/calendar/calendar-calendarV2.php';
require __DIR__.'/routes/calendar/calendar-eventsV2.php';

// file manager documents routes
require __DIR__.'/routes/documents/documents-document.php';
require __DIR__.'/routes/documents/documents-ckeditor.php';
require __DIR__.'/routes/documents/documents-filemanager.php';
require __DIR__.'/routes/documents/documents-sharedocument.php';

// finance routes
require __DIR__.'/routes/finance/finance-deposits.php';
require __DIR__.'/routes/finance/finance-donationfunds.php';
require __DIR__.'/routes/finance/finance-payments.php';
require __DIR__.'/routes/finance/finance-pledges.php';

// people families and persons routes
require __DIR__.'/routes/people/people.php';
require __DIR__.'/routes/people/people-attendees.php';
require __DIR__.'/routes/people/people-families.php';
require __DIR__.'/routes/people/people-groups.php';
require __DIR__.'/routes/people/people-persons.php';

// public routes
require __DIR__.'/routes/public/public-data.php';
require __DIR__.'/routes/public/public-register.php';

// system sidebar routes
require __DIR__.'/routes/sidebar/sidebar-mapicons.php';
require __DIR__.'/routes/sidebar/sidebar-menulinks.php';
require __DIR__.'/routes/sidebar/sidebar-pastoralcare.php';
require __DIR__.'/routes/sidebar/sidebar-properties.php';
require __DIR__.'/routes/sidebar/sidebar-roles.php';
require __DIR__.'/routes/sidebar/sidebar-general-roles.php';
require __DIR__.'/routes/sidebar/sidebar-volunteeropportunity.php';

// system routes
require __DIR__.'/routes/system/system.php';
require __DIR__.'/routes/system/system-custom-fields.php';
require __DIR__.'/routes/system/system-synchronize.php';
require __DIR__.'/routes/system/system-database.php';
require __DIR__.'/routes/system/system-gdrp.php';
require __DIR__.'/routes/system/system-issues.php';
require __DIR__.'/routes/system/system-system-upgrade.php';
require __DIR__.'/routes/system/system-timerjobs.php';

// users routes
require __DIR__.'/routes/user/user-users.php';
require __DIR__.'/routes/user/user-role.php';

// the rest
require __DIR__.'/routes/cart.php';
require __DIR__.'/routes/geocoder.php';
require __DIR__.'/routes/kiosks.php';
require __DIR__.'/routes/mailchimp.php';
require __DIR__.'/routes/search.php';
require __DIR__.'/routes/sundayschool.php';

// Run app
$app->run();
