<?php

require '../Include/Config.php';
require '../Include/Functions.php';

// This file is generated by Composer
require_once dirname(__FILE__).'/../vendor/autoload.php';

use Slim\Factory\AppFactory;
use EcclesiaCRM\TokenQuery;
use Tuupola\Middleware\JwtAuthentication;

// on doit rajouter le cache
// gestion jwt
// gestion middleware

$app = AppFactory::create();

// Register the http cache middleware.
/*$app->add(new \Slim\HttpCache\Cache('public', 86400));

// Create the cache provider.
$cacheProvider = new \Slim\HttpCache\CacheProvider();*/


$app->setBasePath("/v2");



$tokenJWT = null;

if ( !is_null (TokenQuery::Create()->findOneByType("secret")) ) {
    $tokenJWT = TokenQuery::Create()->findOneByType("secret")->getToken();

    /*$app->add(new JwtAuthentication([
        "secret" => $tokenJWT,
        "path" => "/v2",
        "algorithm" => ["HS256"],
        "error" => function ($response, $arguments) {
            $data["status"] = "error";
            $data["message"] = $arguments["message"];
            return $response
                ->withHeader("Content-Type", "application/json")
                ->write(json_encode($data, 'JSON_UNESCAPED_SLASHES' | 'JSON_PRETTY_PRINT'));
        }
    ]));*/
}

// the main dashboard
require __DIR__ . '/routes/dashboard.php';

// the routes
require __DIR__ . '/routes/user/user.php';
require __DIR__ . '/routes/calendar/calendar.php';
require __DIR__ . '/routes/gdpr/gdpr.php';
require __DIR__ . '/routes/map/map.php';



/*

// Set up
//require __DIR__.'/../Include/slim/error-handler.php';


// the routes
/*

// the sidebar routes
require __DIR__ . '/routes/sidebar/menulinklist.php';
require __DIR__ . '/routes/sidebar/pastoralcarelist.php';
require __DIR__ . '/routes/sidebar/fundlist.php';
require __DIR__ . '/routes/sidebar/volunteeropportunityeditor.php';
require __DIR__ . '/routes/sidebar/propertylist.php';
require __DIR__ . '/routes/sidebar/propertytypelist.php';
require __DIR__ . '/routes/sidebar/kioskmanager.php';

// people
require __DIR__ . '/routes/people/people.php';
require __DIR__ . '/routes/people/familylist.php';
require __DIR__ . '/routes/people/personlist.php';

// pastoralcare
require __DIR__ . '/routes/pastoralcare/pastoralcare.php';

require __DIR__ . '/routes/group/groups.php';

// backup route
require __DIR__ . '/routes/backup/backup.php';
require __DIR__ . '/routes/backup/restore.php';

// email routes
// mailchimp
require __DIR__ . '/routes/email/mailchimp/mailchimp.php';

// sunday school route
require __DIR__ . '/routes/sundayschool/sundayschool.php';


// sunday school route
require __DIR__ . '/routes/cart/cart.php';

// meeting
require __DIR__ . '/routes/meeting/meeting.php';

// fundraiser
require __DIR__ . '/routes/fundraiser/fundraiser.php';*/



$app->run();
